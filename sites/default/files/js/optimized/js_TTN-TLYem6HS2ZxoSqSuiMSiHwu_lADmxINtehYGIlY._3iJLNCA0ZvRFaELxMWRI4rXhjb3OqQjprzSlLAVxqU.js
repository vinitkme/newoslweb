(function(e,o,t){'use strict';e.ckeditor.VisualView=o.View.extend({events:{'click .ckeditor-toolbar-group-name':'onGroupNameClick','click .ckeditor-groupnames-toggle':'onGroupNamesToggleClick','click .ckeditor-add-new-group button':'onAddGroupButtonClick'},initialize:function(){this.listenTo(this.model,'change:isDirty change:groupNamesVisible',this.render);t(e.theme('ckeditorButtonGroupNamesToggle')).prependTo(this.$el.find('#ckeditor-active-toolbar').parent());this.render()},render:function(t,o,r){this.insertPlaceholders();this.applySorting();var i=this.model.get('groupNamesVisible');if(r&&r.changes&&r.changes.isDirty){this.model.set({groupNamesVisible:!0},{silent:!0});i=!0};this.$el.find('[data-toolbar="active"]').toggleClass('ckeditor-group-names-are-visible',i);this.$el.find('.ckeditor-groupnames-toggle').text((i)?e.t('Hide group names'):e.t('Show group names')).attr('aria-pressed',i);return this},onGroupNameClick:function(o){var i=t(o.currentTarget).closest('.ckeditor-toolbar-group');e.ckeditor.openGroupNameDialog(this,i);o.stopPropagation();o.preventDefault()},onGroupNamesToggleClick:function(e){this.model.set('groupNamesVisible',!this.model.get('groupNamesVisible'));e.preventDefault()},onAddGroupButtonClick:function(o){function i(e,i){if(e){i.appendTo(t(o.currentTarget).closest('.ckeditor-row').children('.ckeditor-toolbar-groups'));i.trigger('focus')}};e.ckeditor.openGroupNameDialog(this,t(e.theme('ckeditorToolbarGroup')),i);o.preventDefault()},endGroupDrag:function(t,o){var i=this;e.ckeditor.registerGroupMove(this,o.item,function(e){if(!e){i.$el.find('.ckeditor-toolbar-configuration').find('.ui-sortable').sortable('cancel')}})},startButtonDrag:function(e,t){this.$el.find('a:focus').trigger('blur');this.model.set('groupNamesVisible',!0)},endButtonDrag:function(t,o){var i=this;e.ckeditor.registerButtonMove(this,o.item,function(e){if(!e){i.$el.find('.ui-sortable').sortable('cancel')};o.item.find('a').trigger('focus')})},applySorting:function(){this.$el.find('.ckeditor-buttons').not('.ui-sortable').sortable({connectWith:'.ckeditor-buttons',placeholder:'ckeditor-button-placeholder',forcePlaceholderSize:!0,tolerance:'pointer',cursor:'move',start:this.startButtonDrag.bind(this),stop:this.endButtonDrag.bind(this)}).disableSelection();this.$el.find('.ckeditor-toolbar-groups').not('.ui-sortable').sortable({connectWith:'.ckeditor-toolbar-groups',cancel:'.ckeditor-add-new-group',placeholder:'ckeditor-toolbar-group-placeholder',forcePlaceholderSize:!0,cursor:'move',stop:this.endGroupDrag.bind(this)});this.$el.find('.ckeditor-multiple-buttons li').draggable({connectToSortable:'.ckeditor-toolbar-active .ckeditor-buttons',helper:'clone'})},insertPlaceholders:function(){this.insertPlaceholderRow();this.insertNewGroupButtons()},insertPlaceholderRow:function(){var o=this.$el.find('.ckeditor-row');if(!o.eq(-1).hasClass('placeholder')){this.$el.find('.ckeditor-toolbar-active').children('.ckeditor-active-toolbar-configuration').append(e.theme('ckeditorRow'))};o=this.$el.find('.ckeditor-row');var i=o.length;o.filter(function(e,o){if(e+1===i){return!1};return t(o).find('.ckeditor-toolbar-group').not('.placeholder').length===0}).remove()},insertNewGroupButtons:function(){this.$el.find('.ckeditor-row').each(function(){var o=t(this),r=o.find('.ckeditor-toolbar-group'),i=o.find('.ckeditor-add-new-group');if(i.length===0){o.children('.ckeditor-toolbar-groups').append(e.theme('ckeditorNewButtonGroup'))}
else if(!r.eq(-1).hasClass('ckeditor-add-new-group')){i.appendTo(o.children('.ckeditor-toolbar-groups'))}})}})})(Drupal,Backbone,jQuery);