(function(e,t,d,i){'use strict';var a=!1;i.quickedit.AppView=d.View.extend({initialize:function(e){this.activeFieldStates=['activating','active'];this.singleFieldStates=['highlighted','activating','active'];this.changedFieldStates=['changed','saving','saved','invalid'];this.readyFieldStates=['candidate','highlighted'];this.listenTo(e.entitiesCollection,'change:state',this.appStateChange);this.listenTo(e.entitiesCollection,'change:isActive',this.enforceSingleActiveEntity);this.listenTo(e.fieldsCollection,'change:state',this.editorStateChange);this.listenTo(e.fieldsCollection,'change:html',this.renderUpdatedField);this.listenTo(e.fieldsCollection,'change:html',this.propagateUpdatedField);this.listenTo(e.fieldsCollection,'add',this.rerenderedFieldToCandidate);this.listenTo(e.fieldsCollection,'destroy',this.teardownEditor)},appStateChange:function(e,d){var o=this,n;switch(d){case'launching':a=!1;n=new i.quickedit.EntityToolbarView({model:e,appModel:this.model});e.toolbarView=n;e.get('fields').each(function(e){o.setupEditor(e)});t.defer(function(){e.set('state','opening')});break;case'closed':n=e.toolbarView;e.get('fields').each(function(e){o.teardownEditor(e)});if(n){n.remove();delete e.toolbarView};if(a){a=!1;location.reload()};break}},acceptEditorStateChange:function(e,a,n,s){var d=!0;if(n&&(n.reason==='stop'||n.reason==='rerender')){if(e==='candidate'&&a==='inactive'){d=!0}}
else{if(!i.quickedit.FieldModel.followsStateSequence(e,a)){d=!1;if(t.indexOf(this.activeFieldStates,e)!==-1&&a==='candidate'){d=!0}
else if((e==='changed'||e==='invalid')&&a==='candidate'){d=!0}
else if(e==='highlighted'&&a==='candidate'){d=!0}
else if(e==='saved'&&a==='candidate'){d=!0}
else if(e==='invalid'&&a==='saving'){d=!0}
else if(e==='invalid'&&a==='activating'){d=!0}};if(d){var o,l;if((this.readyFieldStates.indexOf(e)!==-1||e==='invalid')&&this.activeFieldStates.indexOf(a)!==-1){o=this.model.get('activeField');if(o&&o!==s){l=o.get('state');if(this.activeFieldStates.indexOf(l)!==-1){o.set('state','candidate')}
else if(l==='changed'||l==='invalid'){o.set('state','saving')};if(e==='invalid'){this.model.set('activeField',s);d=!1}}}
else if(t.indexOf(this.activeFieldStates,e)!==-1&&a==='candidate'){if(n&&n.reason==='mouseleave'){d=!1}}
else if((e==='changed'||e==='invalid')&&a==='candidate'){if(n&&n.reason==='mouseleave'){d=!1}
else{if(n&&n.confirmed){d=!0}}}}};return d},setupEditor:function(t){var d=t.get('entity'),l=d.toolbarView,r=l.getToolbarRoot(),o=t.get('metadata').editor,n=new i.quickedit.EditorModel(),a=new i.quickedit.editors[o]({el:e(t.get('el')),model:n,fieldModel:t});var c=new i.quickedit.FieldToolbarView({el:r,model:t,$editedElement:e(a.getEditedElement()),editorView:a,entityModel:d});var s=new i.quickedit.FieldDecorationView({el:e(a.getEditedElement()),model:t,editorView:a});t.editorView=a;t.toolbarView=c;t.decorationView=s},teardownEditor:function(e){if(typeof e.editorView==='undefined'){return};e.toolbarView.remove();delete e.toolbarView;e.decorationView.remove();delete e.decorationView;e.editorView.remove();delete e.editorView},confirmEntityDeactivation:function(t){var o=this,d;function n(e){d.close(e);o.model.set('activeModal',null);if(e==='save'){t.set('state','committing',{confirmed:!0})}
else{t.set('state','deactivating',{confirmed:!0});if(t.get('reload')){a=!0;t.set('reload',!1)}}};if(!this.model.get('activeModal')){var l=e('<div>'+i.t('You have unsaved changes')+'</div>');d=i.dialog(l.get(0),{title:i.t('Discard changes?'),dialogClass:'quickedit-discard-modal',resizable:!1,buttons:[{text:i.t('Save'),click:function(){n('save')},primary:!0},{text:i.t('Discard changes'),click:function(){n('discard')}}],closeOnEscape:!1,create:function(){e(this).parent().find('.ui-dialog-titlebar-close').remove()},beforeClose:!1,close:function(i){e(i.target).remove()}});this.model.set('activeModal',d);d.showModal()}},editorStateChange:function(e,i){var d=e.previous('state'),a=i;if(t.indexOf(this.singleFieldStates,a)!==-1&&this.model.get('highlightedField')!==e){this.model.set('highlightedField',e)}
else if(this.model.get('highlightedField')===e&&a==='candidate'){this.model.set('highlightedField',null)};if(t.indexOf(this.activeFieldStates,a)!==-1&&this.model.get('activeField')!==e){this.model.set('activeField',e)}
else if(this.model.get('activeField')===e&&a==='candidate'){if(d==='changed'||d==='invalid'){e.editorView.revert()};this.model.set('activeField',null)}},renderUpdatedField:function(a,d,n){var o=e(a.get('el')),s=o.parent(),l=function(){a.destroy();o.replaceWith(d);i.attachBehaviors(s.get(0))};if(!n.propagation){t.defer(function(){a.set('state','candidate');t.defer(function(){a.set('state','inactive',{reason:'rerender'});l()})})}
else{l()}},propagateUpdatedField:function(e,t,a){if(a.propagation){return};var d=e.get('htmlForOtherViewModes');i.quickedit.collections.fields.where({logicalFieldID:e.get('logicalFieldID')}).forEach(function(i){if(i===e){return}
else if(i.getViewMode()===e.getViewMode()){i.set('html',e.get('html'))}
else{if(i.getViewMode()in d){i.set('html',d[i.getViewMode()],{propagation:!0})}}})},rerenderedFieldToCandidate:function(e){var t=i.quickedit.collections.entities.findWhere({isActive:!0});if(!t){return};if(e.get('entity')===t){this.setupEditor(e);e.set('state','candidate')}},enforceSingleActiveEntity:function(e){if(e.get('isActive')===!1){return};e.collection.chain().filter(function(i){return i.get('isActive')===!0&&i!==e}).each(function(e){e.set('state','deactivating')})}})}(jQuery,_,Backbone,Drupal));