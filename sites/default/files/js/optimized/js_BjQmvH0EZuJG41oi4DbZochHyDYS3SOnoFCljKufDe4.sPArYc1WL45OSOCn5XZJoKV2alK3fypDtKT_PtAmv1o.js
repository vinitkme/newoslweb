(function(e,i,o,t,n){'use strict';t.quickedit.EntityToolbarView=o.View.extend({_fieldToolbarRoot:null,events:function(){var e={'click button.action-save':'onClickSave','click button.action-cancel':'onClickCancel','mouseenter':'onMouseenter'};return e},initialize:function(t){var i=this;this.appModel=t.appModel;this.$entity=e(this.model.get('el'));this.listenTo(this.model,'change:isActive change:isDirty change:state',this.render);this.listenTo(this.appModel,'change:highlightedField change:activeField',this.render);this.listenTo(this.model.get('fields'),'change:state',this.fieldStateChange);e(window).on('resize.quickedit scroll.quickedit',n(e.proxy(this.windowChangeHandler,this),150));e(document).on('drupalViewportOffsetChange.quickedit',function(e,t){if(i.$fence){i.$fence.css(t)}});var o=this.buildToolbarEl();this.setElement(o);this._fieldToolbarRoot=o.find('.quickedit-toolbar-field').get(0);this.render()},render:function(){if(this.model.get('isActive')){var i=e('body');if(i.children('#quickedit-entity-toolbar').length===0){i.append(this.$el)};if(i.children('#quickedit-toolbar-fence').length===0){this.$fence=e(t.theme('quickeditEntityToolbarFence')).css(t.displace()).appendTo(i)};this.label();this.show('ops');this.position()};var o=this.$el.find('.quickedit-button.action-save'),n=this.model.get('isDirty');switch(this.model.get('state')){case'opened':o.removeClass('action-saving icon-throbber icon-end').text(t.t('Save')).removeAttr('disabled').attr('aria-hidden',!n);break;case'committing':o.addClass('action-saving icon-throbber icon-end').text(t.t('Saving')).attr('disabled','disabled');break;default:o.attr('aria-hidden',!0);break};return this},remove:function(){this.$fence.remove();e(window).off('resize.quickedit scroll.quickedit');e(document).off('drupalViewportOffsetChange.quickedit');o.View.prototype.remove.call(this)},windowChangeHandler:function(e){this.position()},fieldStateChange:function(e,t){switch(t){case'active':this.render();break;case'invalid':this.render();break}},position:function(e){clearTimeout(this.timer);var c=this,h=(document.documentElement.dir==='rtl')?'right':'left',d=0,f=0,r=0,n,o,l;do{switch(f){case 0:n=e;break;case 1:o=t.quickedit.app.model.get('activeField');n=o&&o.editorView&&o.editorView.$formContainer&&o.editorView.$formContainer.find('.quickedit-form');break;case 2:n=o&&o.editorView&&o.editorView.getEditedElement();if(o&&o.editorView&&o.editorView.getQuickEditUISettings().padding){r=5};break;case 3:l=t.quickedit.app.model.get('highlightedField');n=l&&l.editorView&&l.editorView.getEditedElement();d=250;break;default:var s=this.model.get('fields').models;var m=1000000,b=null;for(var a=0;a<s.length;a++){var u=s[a].get('el').getBoundingClientRect().top;if(u<m){m=u;b=s[a]}};n=b.get('el');d=50;break};f++}
while(!n);function p(e,t,i){var l=t.top>i.target.top;i.element.element.toggleClass('quickedit-toolbar-pointer-top',l);if(e.$entity[0]===i.target.element[0]){var o=e.$entity.find('.quickedit-editable').eq((l)?-1:0);if(o.length>0){t.top=(l)?(o.offset().top+o.outerHeight(!0)):o.offset().top-i.element.element.outerHeight(!0)}};var n=e.$fence.offset().top,a=e.$fence.height(),d=i.element.element.outerHeight(!0);if(t.top<n){t.top=n}
else if((t.top+d)>(n+a)){t.top=n+a-d};i.element.element.css({left:Math.floor(t.left),top:Math.floor(t.top)})};function g(){c.$el.position({my:h+' bottom',at:h+'+'+(1+r)+' top',of:n,collision:'flipfit',using:p.bind(null,c),within:c.$fence}).css({'max-width':(document.documentElement.clientWidth<450)?document.documentElement.clientWidth:450,'min-width':(document.documentElement.clientWidth<240)?document.documentElement.clientWidth:240,'width':'100%'})};this.timer=setTimeout(function(){i.defer(g)},d)},onClickSave:function(e){e.stopPropagation();e.preventDefault();this.model.set('state','committing')},onClickCancel:function(e){e.preventDefault();this.model.set('state','deactivating')},onMouseenter:function(e){clearTimeout(this.timer)},buildToolbarEl:function(){var i=e(t.theme('quickeditEntityToolbar',{id:'quickedit-entity-toolbar'}));i.find('.quickedit-toolbar-entity').prepend(t.theme('quickeditToolgroup',{classes:['ops'],buttons:[{label:t.t('Save'),type:'submit',classes:'action-save quickedit-button icon',attributes:{'aria-hidden':!0}},{label:t.t('Close'),classes:'action-cancel quickedit-button icon icon-close icon-only'}]}));i.css({left:this.$entity.offset().left,top:this.$entity.offset().top});return i},getToolbarRoot:function(){return this._fieldToolbarRoot},label:function(){var e='',i=this.model.get('label'),l=t.quickedit.app.model.get('activeField'),a=l&&l.get('metadata').label,n=t.quickedit.app.model.get('highlightedField'),o=n&&n.get('metadata').label;if(a){e=t.theme('quickeditEntityToolbarLabel',{entityLabel:i,fieldLabel:a})}
else if(o){e=t.theme('quickeditEntityToolbarLabel',{entityLabel:i,fieldLabel:o})}
else{e=t.checkPlain(i)};this.$el.find('.quickedit-toolbar-label').html(e)},addClass:function(e,t){this._find(e).addClass(t)},removeClass:function(e,t){this._find(e).removeClass(t)},_find:function(e){return this.$el.find('.quickedit-toolbar .quickedit-toolgroup.'+e)},show:function(e){this.$el.removeClass('quickedit-animate-invisible')}})})(jQuery,_,Backbone,Drupal,Drupal.debounce);