(function(e,i,o,t,q,p,d){'use strict';var v=e.extend(q.quickedit,{strings:{quickEdit:t.t('Quick edit')}});var n=[],c=[],a=[],u={};t.behaviors.quickedit={attach:function(t){e('body').once('quickedit-init').each(w);var n=e(t).find('[data-quickedit-field-id]').once('quickedit');if(n.length===0){return};e(t).find('[data-quickedit-entity-id]').once('quickedit').each(function(e,t){I(t)});n.each(function(e,t){f(t)});a=i.filter(a,function(e){return!r(e)});y(function(e){i.each(e,f);a=i.filter(a,function(e){return!r(e)})})},detach:function(t,i,n){if(n==='unload'){g(e(t))}}};t.quickedit={app:null,collections:{entities:null,fields:null},editors:{},metadata:{has:function(e){return d.getItem(this._prefixFieldID(e))!==null},add:function(e,t){d.setItem(this._prefixFieldID(e),p.stringify(t))},get:function(e,t){var i=p.parse(d.getItem(this._prefixFieldID(e)));return(typeof t==='undefined')?i:i[t]},_prefixFieldID:function(e){return'Drupal.quickedit.metadata.'+e},_unprefixFieldID:function(e){return e.substring(26)},intersection:function(e){var n=i.map(e,this._prefixFieldID),t=i.intersection(n,i.keys(sessionStorage));return i.map(t,this._unprefixFieldID)}}};var s=t.quickedit.metadata._prefixFieldID('permissionsHash'),m=d.getItem(s),l=q.user.permissionsHash;if(m!==l){if(typeof l==='string'){i.chain(d).keys().each(function(e){if(e.substring(0,26)==='Drupal.quickedit.metadata.'){d.removeItem(e)}})};d.setItem(s,l)};e(document).on('drupalContextualLinkAdded',function(e,t){if(t.$region.is('[data-quickedit-entity-id]')){if(!t.$region.is('[data-quickedit-entity-instance-id]')){t.$region.once('quickedit');I(t.$region.get(0))};var i={entityID:t.$region.attr('data-quickedit-entity-id'),entityInstanceID:t.$region.attr('data-quickedit-entity-instance-id'),el:t.$el[0],region:t.$region[0]};if(!r(i)){a.push(i)}}});function D(e){return e.split('/').slice(0,2).join('/')};function w(e){t.quickedit.collections.entities=new t.quickedit.EntityCollection();t.quickedit.collections.fields=new t.quickedit.FieldCollection();t.quickedit.app=new t.quickedit.AppView({el:e,model:new t.quickedit.AppModel(),entitiesCollection:t.quickedit.collections.entities,fieldsCollection:t.quickedit.collections.fields})};function I(e){var t=e.getAttribute('data-quickedit-entity-id');if(!u.hasOwnProperty(t)){u[t]=0}
else{u[t]++};var i=u[t];e.setAttribute('data-quickedit-entity-instance-id',i)};function f(i){var l=t.quickedit.metadata,a=i.getAttribute('data-quickedit-field-id'),d=D(a),o='[data-quickedit-entity-id="'+d+'"]',r=e(i).closest(o);if(r.length===0){var s=e(o).parents().has(i).first();r=s.find(o)};var u=r.get(0).getAttribute('data-quickedit-entity-instance-id');if(!l.has(a)){n.push({el:i,fieldID:a,entityID:d,entityInstanceID:u});return};if(l.get(a,'access')!==!0){return};if(t.quickedit.collections.entities.findWhere({entityID:d,entityInstanceID:u})){k(i,a,d,u)}
else{c.push({el:i,fieldID:a,entityID:d,entityInstanceID:u})}};function k(n,a,d,c){var u=t.quickedit.collections.entities.findWhere({entityID:d,entityInstanceID:c});e(n).addClass('quickedit-field');var r=new t.quickedit.FieldModel({el:n,fieldID:a,id:a+'['+u.get('entityInstanceID')+']',entity:u,metadata:t.quickedit.metadata.get(a),acceptStateChange:i.bind(t.quickedit.app.acceptEditorStateChange,t.quickedit.app)});t.quickedit.collections.fields.add(r)};function y(a){if(n.length){var c=i.pluck(n,'fieldID'),u=i.pluck(n,'el'),d=i.uniq(i.pluck(n,'entityID'),!0);d=i.difference(d,t.quickedit.metadata.intersection(d));n=[];e.ajax({url:t.url('quickedit/metadata'),type:'POST',data:{'fields[]':c,'entities[]':d},dataType:'json',success:function(e){i.each(e,function(e,i){t.quickedit.metadata.add(i,e)});a(u)}})}};function h(e){var c=i.keys(t.quickedit.editors),n=[];t.quickedit.collections.fields.each(function(e){var a=t.quickedit.metadata.get(e.get('fieldID'));if(a.access&&i.indexOf(c,a.editor)===-1){n.push(a.editor);t.quickedit.editors[a.editor]=!1}});n=i.uniq(n);if(n.length===0){e();return};var a=t.ajax({url:t.url('quickedit/attachments'),submit:{'editors[]':n}});var d=t.AjaxCommands.prototype.insert;a.commands.insert=function(t,n,a){i.defer(e);d(t,n,a)};a.execute()};function r(n){var r=t.quickedit.metadata;function l(e){for(var t=0;t<e.length;t++){var i=e[t];if(r.get(i,'access')===!0){return!0}};return!1};function o(e){return e.length===r.intersection(e).length};var d=i.where(c,{entityID:n.entityID,entityInstanceID:n.entityInstanceID});var u=i.pluck(d,'fieldID');if(u.length===0){return!1}
else if(l(u)){var a=new t.quickedit.EntityModel({el:n.region,entityID:n.entityID,entityInstanceID:n.entityInstanceID,id:n.entityID+'['+n.entityInstanceID+']',label:t.quickedit.metadata.get(n.entityID,'label')});t.quickedit.collections.entities.add(a);var s=new t.quickedit.EntityDecorationView({el:n.region,model:a});a.set('entityDecorationView',s);i.each(d,function(e){k(e.el,e.fieldID,n.entityID,n.entityInstanceID)});c=i.difference(c,d);var f=i.once(function(){var d=e(n.el).find('.contextual-links'),i=new t.quickedit.ContextualLinkView(e.extend({el:e('<li class="quickedit"><a href="" role="button" aria-pressed="false"></a></li>').prependTo(d),model:a,appModel:t.quickedit.app.model},v));a.set('contextualLinkView',i)});h(f);return!0}
else if(o(u)){return!0};return!1};function g(e){e.find('[data-quickedit-entity-id]').addBack('[data-quickedit-entity-id]').each(function(e,n){var d=t.quickedit.collections.entities.findWhere({el:n});if(d){var c=d.get('contextualLinkView');c.undelegateEvents();c.remove();d.get('entityDecorationView').remove();d.destroy()};function u(e){return e.region!==n};a=i.filter(a,u)});e.find('[data-quickedit-field-id]').addBack('[data-quickedit-field-id]').each(function(e,a){t.quickedit.collections.fields.chain().filter(function(e){return e.get('el')===a}).invoke('destroy');function d(e){return e.el!==a};n=i.filter(n,d);c=i.filter(c,d)})}})(jQuery,_,Backbone,Drupal,drupalSettings,window.JSON,window.sessionStorage);