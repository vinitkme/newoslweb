(function(s,e,t,a){'use strict';if(e.filterConfiguration){e.filterConfiguration.liveSettingParsers.filter_html={getRules:function(){var r=s('#edit-filters-filter-html-settings-allowed-html').val(),a=e.behaviors.filterFilterHtmlUpdating._parseSetting(r),t=new e.FilterHTMLRule();t.restrictedTags.tags=['*'];t.restrictedTags.forbidden.attributes=['style','on*'];a.push(t);return a}}};e.behaviors.filterFilterHtmlUpdating={$allowedHTMLFormItem:null,$allowedHTMLDescription:null,userTags:{},autoTags:null,newFeatures:{},attach:function(r,i){var e=this;s(r).find('[name="filters[filter_html][settings][allowed_html]"]').once('filter-filter_html-updating').each(function(){e.$allowedHTMLFormItem=s(this);e.$allowedHTMLDescription=e.$allowedHTMLFormItem.closest('.js-form-item').find('.description');e.userTags=e._parseSetting(this.value);s(a).on('drupalEditorFeatureAdded',function(t,s){e.newFeatures[s.name]=s.rules;e._updateAllowedTags()}).on('drupalEditorFeatureModified',function(s,t){if(e.newFeatures.hasOwnProperty(t.name)){e.newFeatures[t.name]=t.rules;e._updateAllowedTags()}}).on('drupalEditorFeatureRemoved',function(t,s){if(e.newFeatures.hasOwnProperty(s.name)){delete e.newFeatures[s.name];e._updateAllowedTags()}});e.$allowedHTMLFormItem.on('change.updateUserTags',function(){e.userTags=t.difference(e._parseSetting(this.value),e.autoTags)})})},_updateAllowedTags:function(){this.autoTags=this._calculateAutoAllowedTags(this.userTags,this.newFeatures);this.$allowedHTMLDescription.find('.editor-update-message').remove();if(!t.isEmpty(this.autoTags)){this.$allowedHTMLDescription.append(e.theme('filterFilterHTMLUpdateMessage',this.autoTags));var s=t.omit(this.userTags,t.keys(this.autoTags));this.$allowedHTMLFormItem.val(this._generateSetting(s)+' '+this._generateSetting(this.autoTags))}
else{this.$allowedHTMLFormItem.val(this._generateSetting(this.userTags))}},_calculateAutoAllowedTags:function(a,i){var c,g,l,r,s,n={};for(c in i){if(i.hasOwnProperty(c)){g=i[c];for(var f=0;f<g.length;f++){l=g[f];for(var h=0;h<l.required.tags.length;h++){s=l.required.tags[h];if(!t.has(n,s)){r=new e.FilterHTMLRule();r.restrictedTags.tags=[s];r.restrictedTags.allowed.attributes=l.required.attributes.slice(0);r.restrictedTags.allowed.classes=l.required.classes.slice(0);n[s]=r}
else{r=n[s];r.restrictedTags.allowed.attributes=t.union(r.restrictedTags.allowed.attributes,l.required.attributes);r.restrictedTags.allowed.classes=t.union(r.restrictedTags.allowed.classes,l.required.classes)}}}}};var o={};for(s in n){if(!t.has(a,s)){o[s]=n[s]}
else{var u=n[s].restrictedTags.allowed.attributes,w=a[s].restrictedTags.allowed.attributes,m=u.length&&t.difference(u,w).length,d=n[s].restrictedTags.allowed.classes,T=a[s].restrictedTags.allowed.classes,p=d.length&&t.difference(d,T).length;if(m||p){o[s]=a[s].clone()};if(m){o[s].restrictedTags.allowed.attributes=t.union(w,u)};if(p){o[s].restrictedTags.allowed.classes=t.union(T,d)}}};return o},_parseSetting:function(t){var l,n,s,r,i,u=t.match(/(<[^>]+>)/g),g=a.createElement('div'),f={};for(var o=0;o<u.length;o++){g.innerHTML=u[o];l=g.firstChild;n=l.tagName.toLowerCase();s=new e.FilterHTMLRule();s.restrictedTags.tags=[n];r=l.attributes;for(var d=0;d<r.length;d++){i=r.item(d);var c=i.nodeName;if(c==='class'){var h=i.textContent;s.restrictedTags.allowed.classes=h.split(' ')}
else{s.restrictedTags.allowed.attributes.push(c)}};f[n]=s};return f},_generateSetting:function(e){return t.reduce(e,function(e,t,s){if(e.length){e+=' '};e+='<'+s;if(t.restrictedTags.allowed.attributes.length){e+=' '+t.restrictedTags.allowed.attributes.join(' ')};if(t.restrictedTags.allowed.classes.length){e+=' class="'+t.restrictedTags.allowed.classes.join(' ')+'"'};e+='>';return e},'')}};e.theme.filterFilterHTMLUpdateMessage=function(t){var s='',a=e.behaviors.filterFilterHtmlUpdating._generateSetting(t);s+='<p class="editor-update-message">';s+=e.t('Based on the text editor configuration, these tags have automatically been added: <strong>@tag-list</strong>.',{'@tag-list':a});s+='</p>';return s}})(jQuery,Drupal,_,document);