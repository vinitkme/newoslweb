(function(t,e,o,r,i){'use strict';e.ckeditor.ControllerView=o.View.extend({events:{},initialize:function(){this.getCKEditorFeatures(this.model.get('hiddenEditorConfig'),this.disableFeaturesDisallowedByFilters.bind(this));this.model.listenTo(this.model,'change:activeEditorConfig',this.model.sync);this.listenTo(this.model,'change:isDirty',this.parseEditorDOM)},parseEditorDOM:function(e,r,n){if(r){var s=this.model.get('activeEditorConfig'),d=[];this.$el.find('.ckeditor-active-toolbar-configuration').children('.ckeditor-row').each(function(){var e=[];t(this).find('.ckeditor-toolbar-group').each(function(){var i=t(this),o=i.find('.ckeditor-button');if(o.length){var r={name:i.attr('data-drupal-ckeditor-toolbar-group-name'),items:[]};i.find('.ckeditor-button, .ckeditor-multiple-button').each(function(){r.items.push(t(this).attr('data-drupal-ckeditor-button-name'))});e.push(r)}});if(e.length){d.push(e)}});this.model.set('activeEditorConfig',d);this.model.set('isDirty',!1);if(n.broadcast!==!1){var a=this.getButtonList(s),o=this.getButtonList(d);if(a.length!==o.length){this.$el.find('.ckeditor-toolbar-active').trigger('CKEditorToolbarChanged',[(a.length<o.length)?'added':'removed',i.difference(i.union(a,o),i.intersection(a,o))[0]])}}}},getCKEditorFeatures:function(o,a){var n=function(t){return(i.isObject(t))?i.keys(t):[]},f=function(t,o){for(var a=0;a<o.length;a++){var r=o[a],i=new e.EditorFeatureHTMLRule(),d=n(r.elements);i.required.tags=(r.propertiesOnly)?[]:d;i.allowed.tags=d;i.required.attributes=n(r.requiredAttributes);i.allowed.attributes=n(r.attributes);i.required.styles=n(r.requiredStyles);i.allowed.styles=n(r.styles);i.required.classes=n(r.requiredClasses);i.allowed.classes=n(r.classes);i.raw=r;t.addHTMLRule(i)}},d='ckeditor-hidden';if(r.instances[d]){r.instances[d].destroy(!0)};var u=this.model.get('hiddenEditorConfig');if(u.drupalExternalPlugins){var s=u.drupalExternalPlugins;for(var l in s){if(s.hasOwnProperty(l)){r.plugins.addExternal(l,s[l],'')}}};r.inline(t('#'+d).get(0),o);r.once('instanceReady',function(t){if(t.editor.name===d){var r={};var l=t.editor.filter.allowedContent,s,o;for(var n=0;n<l.length;n++){s=l[n];o=s.featureName||':(';if(!r[o]){r[o]=[]};r[o].push(s)};var u={};var g={};for(var i in r){if(r.hasOwnProperty(i)){var c=new e.EditorFeature(i);f(c,r[i]);u[i]=c;var h=t.editor.getCommand(i);if(h){g[h.uiItems[0].name]=i}}};a(u,g)}})},getFeatureForButton:function(t){if(t==='-'){return!1};var i=this.model.get('buttonsToFeatures')[t.toLowerCase()];if(!i){i=t.toLowerCase()};var r=this.model.get('featuresMetadata');if(!r[i]){r[i]=new e.EditorFeature(i);this.model.set('featuresMetadata',r)};return r[i]},disableFeaturesDisallowedByFilters:function(r,o){this.model.set('featuresMetadata',r);this.model.set('buttonsToFeatures',o);this.broadcastConfigurationChanges(this.$el);var a=[],u=i.flatten(this.model.get('activeEditorConfig'));for(var d=0;d<u.length;d++){var f=u[d].items;for(var s=0;s<f.length;s++){a.push(f[s])}};a=i.unique(a);for(var n=0;n<a.length;n++){var l=a[n],h=this.getFeatureForButton(l);if(h===!1){continue};if(e.editorConfiguration.featureIsAllowedByFilters(h)){this.$el.find('.ckeditor-toolbar-active').trigger('CKEditorToolbarChanged',['added',a[n]])}
else{t('.ckeditor-toolbar-active li[data-drupal-ckeditor-button-name="'+l+'"]').detach().appendTo('.ckeditor-toolbar-disabled > .ckeditor-toolbar-available > ul');this.model.set({isDirty:!0},{broadcast:!1})}}},broadcastConfigurationChanges:function(t){var o=this,r=this.model.get('hiddenEditorConfig'),n=this.getFeatureForButton.bind(this),a=this.getCKEditorFeatures.bind(this);t.find('.ckeditor-toolbar-active').on('CKEditorToolbarChanged.ckeditorAdmin',function(t,i,r){var o=n(r);if(o===!1){return};var a=(i==='added')?'addedFeature':'removedFeature';e.editorConfiguration[a](o)}).on('CKEditorPluginSettingsChanged.ckeditorAdmin',function(t,n){for(var d in n){if(n.hasOwnProperty(d)){r[d]=n[d]}};a(r,function(t){var a=o.model.get('featuresMetadata');for(var r in t){if(t.hasOwnProperty(r)){var n=t[r];if(a.hasOwnProperty(r)&&!i.isEqual(a[r],n)){e.editorConfiguration.modifiedFeature(n)}}};o.model.set('featuresMetadata',t)})})},getButtonList:function(t){var e=[];t=i.flatten(t);t.forEach(function(t){t.items.forEach(function(t){e.push(t)})});return i.without(e,'-')}})})(jQuery,Drupal,Backbone,CKEDITOR,_);